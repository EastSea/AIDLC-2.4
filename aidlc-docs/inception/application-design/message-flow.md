# Message Flow Design

## Overview
시스템 내 주요 비즈니스 플로우별 메시지 흐름 정의

---

## 1. 테이블 로그인 Flow

```
+----------+       +----------+       +----------+       +----------+
| Customer |       | Frontend |       | Backend  |       | Database |
| (Tablet) |       | (React)  |       | (FastAPI)|       | (PgSQL)  |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. 화면 접근      |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. 저장된 인증정보 확인               |
     |                  |----+             |                  |
     |                  |    | localStorage|                  |
     |                  |<---+             |                  |
     |                  |                  |                  |
     |                  | 3. POST /api/customer/auth/login    |
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 4. SELECT tables |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 5. 테이블 정보    |
     |                  |                  |<-----------------|
     |                  |                  |                  |
     |                  |                  | 6. 세션 생성/조회 |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  | 7. { token, tableId, sessionId }    |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     | 8. 메뉴 화면 표시 |                  |                  |
     |<-----------------|                  |                  |
```

---

## 2. 메뉴 조회 Flow

```
+----------+       +----------+       +----------+       +----------+
| Customer |       | Frontend |       | Backend  |       | Database |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. 카테고리 선택  |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. GET /api/customer/categories     |
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 3. SELECT categories
     |                  |                  |----------------->|
     |                  |                  |<-----------------|
     |                  |                  |                  |
     |                  | 4. [categories]  |                  |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     |                  | 5. GET /api/customer/menus?category_id=X&serving_size=Y
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 6. SELECT menus  |
     |                  |                  |----------------->|
     |                  |                  |<-----------------|
     |                  |                  |                  |
     |                  | 7. [menus]       |                  |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     | 8. 메뉴 그리드 표시                  |                  |
     |<-----------------|                  |                  |
```

---

## 3. 장바구니 → 주문 Flow

```
+----------+       +----------+       +----------+       +----------+
| Customer |       | Frontend |       | Backend  |       | Database |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. 메뉴 담기      |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. localStorage 저장                |
     |                  |----+             |                  |
     |                  |<---+             |                  |
     |                  |                  |                  |
     | 3. 주문하기 클릭  |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 4. POST /api/customer/orders        |
     |                  |    { session_id, items: [{menu_id, qty}] }
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 5. BEGIN TRANSACTION
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 6. INSERT orders |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 7. INSERT order_items
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 8. COMMIT        |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 9. SSE broadcast |
     |                  |                  |----+             |
     |                  |                  |<---+ (to admin)  |
     |                  |                  |                  |
     |                  | 10. { order_id, order_number }      |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     |                  | 11. localStorage.clear()            |
     |                  |----+             |                  |
     |                  |<---+             |                  |
     |                  |                  |                  |
     | 12. 주문완료 화면 |                  |                  |
     |<-----------------|                  |                  |
     |                  |                  |                  |
     | 13. (5초 후) 메뉴화면               |                  |
     |<-----------------|                  |                  |
```

---

## 4. 실시간 주문 모니터링 Flow (SSE)

```
+----------+       +----------+       +----------+       +----------+
|  Admin   |       | Frontend |       | Backend  |       | Database |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. 대시보드 접속  |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. GET /api/sse/orders (EventSource)|
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  | 3. SSE Connection Established       |
     |                  |<-----------------| (keep-alive)     |
     |                  |                  |                  |
     |                  |                  |                  |
     |    ... 고객이 주문 생성 ...         |                  |
     |                  |                  |                  |
     |                  |                  | 4. 주문 저장     |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  | 5. SSE Event: { type: "new_order", data: {...} }
     |                  |<-----------------|                  |
     |                  |                  |                  |
     | 6. 신규 주문 표시 |                  |                  |
     |<-----------------|                  |                  |
     |   (시각적 강조)   |                  |                  |
```

---

## 5. 주문 상태 변경 Flow

```
+----------+       +----------+       +----------+       +----------+       +----------+
|  Admin   |       | Admin FE |       | Backend  |       | Database |       | Cust FE  |
+----------+       +----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |                  |
     | 1. 상태변경 클릭  |                  |                  |                  |
     |  (대기중→준비중)  |                  |                  |                  |
     |----------------->|                  |                  |                  |
     |                  |                  |                  |                  |
     |                  | 2. PATCH /api/admin/orders/{id}/status               |
     |                  |    { status: "preparing" }         |                  |
     |                  |----------------->|                  |                  |
     |                  |                  |                  |                  |
     |                  |                  | 3. UPDATE orders |                  |
     |                  |                  |----------------->|                  |
     |                  |                  |<-----------------|                  |
     |                  |                  |                  |                  |
     |                  |                  | 4. SSE broadcast (order_status_changed)
     |                  |                  |----+             |                  |
     |                  |                  |<---+             |                  |
     |                  |                  |                  |                  |
     |                  | 5. { success }   |                  |                  |
     |                  |<-----------------|                  |                  |
     |                  |                  |                  |                  |
     | 6. UI 업데이트    |                  |                  |                  |
     |<-----------------|                  |                  |                  |
     |                  |                  |                  |                  |
     |                  |                  | 7. SSE Event to Customer FE        |
     |                  |                  |---------------------------------->|
     |                  |                  |                  |                  |
     |                  |                  |                  | 8. 상태 업데이트 |
     |                  |                  |                  |    (고객 화면)   |
```

---

## 6. 테이블 이용 완료 Flow

```
+----------+       +----------+       +----------+       +----------+
|  Admin   |       | Frontend |       | Backend  |       | Database |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. 이용완료 클릭  |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. 확인 팝업     |                  |
     |                  |----------------->|                  |
     |                  |                  |                  |
     | 3. 확인           |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 4. POST /api/admin/tables/{id}/complete
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 5. BEGIN TRANSACTION
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 6. UPDATE table_sessions
     |                  |                  |    SET is_active=false, ended_at=now()
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  |                  | 7. COMMIT        |
     |                  |                  |----------------->|
     |                  |                  |                  |
     |                  | 8. { success }   |                  |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     | 9. 테이블 카드 리셋                  |                  |
     |<-----------------|                  |                  |
```

---

## 7. 직원 호출 Flow

```
+----------+       +----------+       +----------+       +----------+       +----------+
| Customer |       | Cust FE  |       | Backend  |       | Database |       | Admin FE |
+----------+       +----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |                  |
     | 1. 직원호출 클릭  |                  |                  |                  |
     |----------------->|                  |                  |                  |
     |                  |                  |                  |                  |
     |                  | 2. POST /api/customer/staff-call    |                  |
     |                  |    { table_id }  |                  |                  |
     |                  |----------------->|                  |                  |
     |                  |                  |                  |                  |
     |                  |                  | 3. INSERT staff_calls              |
     |                  |                  |----------------->|                  |
     |                  |                  |                  |                  |
     |                  |                  | 4. SSE broadcast |                  |
     |                  |                  |----+             |                  |
     |                  |                  |<---+             |                  |
     |                  |                  |                  |                  |
     |                  | 5. { success }   |                  |                  |
     |                  |<-----------------|                  |                  |
     |                  |                  |                  |                  |
     | 6. "호출되었습니다"                  |                  |                  |
     |<-----------------|                  |                  |                  |
     |                  |                  |                  |                  |
     |                  |                  | 7. SSE Event: staff_call           |
     |                  |                  |---------------------------------->|
     |                  |                  |                  |                  |
     |                  |                  |                  | 8. 호출 알림 표시|
```

---

## 8. MCP Server Flow (Customer)

```
+----------+       +----------+       +----------+       +----------+
| Chatbot  |       | Customer |       | Backend  |       | Database |
| (Client) |       | MCP Srv  |       | (FastAPI)|       | (PgSQL)  |
+----------+       +----------+       +----------+       +----------+
     |                  |                  |                  |
     | 1. Tool Call:    |                  |                  |
     |    get_menu_list |                  |                  |
     |----------------->|                  |                  |
     |                  |                  |                  |
     |                  | 2. GET /api/customer/menus          |
     |                  |----------------->|                  |
     |                  |                  |                  |
     |                  |                  | 3. SELECT menus  |
     |                  |                  |----------------->|
     |                  |                  |<-----------------|
     |                  |                  |                  |
     |                  | 4. [menus]       |                  |
     |                  |<-----------------|                  |
     |                  |                  |                  |
     | 5. Tool Result:  |                  |                  |
     |    [menus]       |                  |                  |
     |<-----------------|                  |                  |
```

---

## Message Types Summary

| Flow | Request | Response | SSE Event |
|------|---------|----------|-----------|
| 테이블 로그인 | POST /auth/login | { token, session_id } | - |
| 메뉴 조회 | GET /menus | [Menu] | - |
| 주문 생성 | POST /orders | { order_id, order_number } | new_order |
| 주문 상태 변경 | PATCH /orders/{id}/status | { success } | order_status_changed |
| 테이블 완료 | POST /tables/{id}/complete | { success } | table_completed |
| 직원 호출 | POST /staff-call | { success } | staff_call |
